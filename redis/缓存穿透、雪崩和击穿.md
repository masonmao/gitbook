# 缓存穿透、雪崩和击穿问题

## 缓存穿透

缓存穿透一般在查询数据中一定不存在的数据时才会发生。正常的使用缓存流程大致是，数据查询先进行缓存查询，如果key不存在或者key已经过期，再对数据库进行查询，并把查询到的对象，放进缓存。如果数据库查询对象为空，则不放进缓存。

比如我们根据订单id查询订单信息。想象一下这个情况，如果传入的订单id为-1，会是怎么样？这个-1，就是一定不存在的对象。就会每次都去查询数据库，而每次查询都是空，每次又都不会进行缓存。假如有恶意攻击，就可以利用这个漏洞，对数据库造成压力，甚至压垮数据库。

这种情况下，对于数据库中不存在的数据我们可以考虑采用缓存空值的方式。即查询数据库结果为空时，依然创建缓存，只不过缓存的值为空而已，过期时间可以设置的短一些，如60s。即可避免缓存穿透对数据库造成压力，又能避免浪费空间。

## 缓存雪崩

缓存雪崩，是指在某一个时间段，缓存集中过期失效。

产生这个问题的主要原因在于，我们在某一时刻对大量数据进行缓存，且缓存过期时间相同。那么这部分数据会在同一时间过期，所以的请求全部集中到数据上，因此会对数据库产生周期性的压力波峰。

对于这个问题，可以考虑在设置过期时间时，添加随机因子，尽可能分散缓存过期时间，同时缓存的时间长一些。

## 缓存击穿

缓存击穿，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。

对于这种问题，可以设置该缓存永不过期。